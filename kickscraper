#!/usr/bin/env node

var assert = require('assert'),
    config = require('./config'),
    KickStarter = require('./kickstarter'),
    DB = require('./db');

var ks = new KickStarter(),
    db = new DB();

db.on('added_backer', function(backer) {
  ks.emit('test_message', backer);
});

ks.login()
  .then(function() {
    return ks.get_backers();
  })
  .then(function(backers) {
    assert.notEqual(0, backers.length, 'No backers found');
    return backers;
  })
  .then(function(backers) {
    db.process_backers(backers);
  })
  .fail(function(error) {
    console.log(error);
  });

if(config.debug) {

  ks.on('sent_message', function(user, message) {
    console.log('sent to ' + user);
    console.log(message);
  });

  ks.on('logged_in', function(user, message) {
    console.log('logged_in');
  });

  ks.on('error', function(error) {
    console.log(error);
  });

}
